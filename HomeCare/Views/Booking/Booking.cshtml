@using HomeCare.Models
@model HomeCare.ViewModels.BookingViewModel
@{
    ViewData["Title"] = "Booking";// change this name later
}

<!--Apply base font size and line height for user page-->
<div class="font-resizable-area user-dashboard">
    <div class="container py-4">
        <div class="row g-4">
            <!--Booking-->
            <div class="col-12 col-lg-6">
                <div class="booking-form">
                    <h2>Book time her</h2>

                    @if (TempData["BookingSuccess"] != null)
                    {
                        <div class="alert alert-success">
                            @TempData["BookingSuccess"]
                        </div>
                    }

                    <form asp-action="Booking" method="post">
                        <input type="hidden" asp-for="AppointmentId" /><!--for editing appointment-->
                        <div class="form-group">
                            <label for="SelectedDate">Dato</label>
                            <div class="date-options">
                                @if (Model.AvailableDates != null && Model.AvailableDates.Any())
                                {
                                    foreach (var date in Model.AvailableDates)
                                    {
                                        var availableSlots = date.TimeSlots.Where(ts => !ts.IsBooked).ToList();
                                        var isEditingSlot = date.TimeSlots.Any(ts => ts.Id == Model.TimeSlotId); // 自分の予約枠

                                        <label class="date-option btn btn-outline-secondary m-1">
                                            <input type="radio" name="SelectedDate" value="@date.Date.ToString("yyyy-MM-dd")"
                                                data-date-id="@date.Id" />
                                            @date.Date.ToString("MMM dd")
                                        </label>
                                    }
                                }
                                else
                                {
                                    <p class="text-danger">Ingen ledige datoer funnet.</p>
                                }

                            </div>

                            <span asp-validation-for="SelectedDate" class="text-danger"></span>
                        </div>

                        <div class="form-group">
                            <label for="TimeSlotId">Tidspunkt</label>
                            <div id="time-slot-wrapper" class="mt-2">
                                <div id="time-slot-buttons" class="btn-group-vertical" role="group"
                                    aria-label="Time slots">
                                    <p class="text-muted" id="time-slot-placeholder">Velg et tidspunkt først.</p>
                                </div>
                                <input type="hidden" name="TimeSlotId" id="TimeSlotId" value="" />
                                <span asp-validation-for="TimeSlotId" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="form-group">@if (Model.AvailablePersonnel.Any())
                            {
                                <label>Velg personnel:</label>
                                @foreach (var personnel in Model.AvailablePersonnel)
                                {
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="SelectedPersonnelId"
                                            value="@personnel.Id" id="personnel_@personnel.Id" />
                                        <label class="form-check-label" for="personnel_@personnel.Id">
                                            @personnel.FullName
                                        </label>
                                    </div>
                                }
                            }
                                                        else
                            {
                                <p>Ingen tilgjengelige personnel for valgt dato.</p>
                            }

                        </div>



                        <div class="form-group">
                            <label for="CategoryId">Kategori</label>
                            <select asp-for="CategoryId" class="form-control" id="categorySelect">
                                @foreach (var cat in Model.Categories)
                                {
                                    <option value="@cat.Id">@cat.Name</option>
                                }
                            </select>
                            <span asp-validation-for="CategoryId" class="text-danger"></span>
                        </div>

                        <div class="form-group" id="customCategoryDiv" style="display:none;">
                            <label for="Notes">Notater</label>
                            <textarea asp-for="Notes" class="form-control"></textarea>
                            <span asp-validation-for="Notes" class="text-danger"></span>
                        </div>

                        @* <button type="submit" class="btn btn-primary mt-3">Book</button> *@
                        <button type="submit" class="btn btn-primary mt-3">
                            @(Model.AppointmentId > 0 ? "Oppdater timen" : "Book Time")
                        </button>


                    </form>

                </div>
            </div>

            <!--Booked-->
            <div class="col-12 col-lg-6">
                <div class="booking-list">
                    <h2>Fremtidige Timer</h2>
                    @{
                        int? editingId = ViewBag.EditingId as int?;
                    }

                    @if (ViewBag.Appointments is List<Appointment> appointments && appointments.Any())
                    {
                        <table class="table table-custom">
                            <thead>
                                <tr>
                                    <th>Dato & Tidspunkt</th>
                                    <th>Kategori</th>
                                    <th></th>
                                    <th class="text-end">
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var a in appointments)
                                {
                                    var isEditing = editingId.HasValue && editingId.Value == a.Id;
                                    <tr class="@(isEditing ? "editing-row" : "")">
                                        <td>
                                            @a.DateTime.ToString("yyyy-MM-dd HH:mm")
                                            @if (isEditing)
                                            {
                                                <span class="badge bg-warning text-dark ms-2">Endre timen</span>
                                            }
                                        </td>
                                        <td>@a.Category.Name</td>
                                        <td>@a.Notes</td>
                                        <td class="text-end">
                                            <a asp-action="EditAppointment" asp-route-id="@a.Id"
                                                class="btn btn-sm btn-outline-primary me-1 @(isEditing ? "" : (editingId.HasValue ? "disabled" : ""))">
                                                Endre timen
                                            </a>
                                            <a href="#" onclick="confirmCancel(@a.Id)"
                                                class="btn btn-sm btn-outline-danger @(editingId.HasValue && !isEditing ? "disabled" : "")">
                                                Kanseller timen
                                            </a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <p>Ingen avtaler funnet.</p>
                    }
                </div>
                <div class="mt-3 text-center">
                    <a asp-controller="User" asp-action="Dashboard" class="btn btn-secondary">Tilbake til Min Side</a>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Show Notes field if "Other" is selected
        document.getElementById("categorySelect").addEventListener("change", function () {
            const customDiv = document.getElementById("customCategoryDiv");
            const selectedText = this.options[this.selectedIndex].text;
            customDiv.style.display = selectedText.toUpperCase() === "OTHER" ? "block" : "none";
        });

        const dateRadios = document.querySelectorAll("input[name='SelectedDate']");
        const timeSlotContainer = document.getElementById("time-slot-buttons");
        const timeSlotInput = document.getElementById("TimeSlotId");

        // Razor-safe JS object construction
        const dateSlotMap = {
                                                                                                                                                                        @for (int i = 0; i < Model.AvailableDates.Count; i++)
            {
                var date = Model.AvailableDates[i];

                var slots = date.TimeSlots.Where(ts => !ts.IsBooked || ts.Id == Model.TimeSlotId) // includes booked timeslot
                .ToList();

                @: "@date.Id": [
                    for (int j = 0; j < slots.Count; j++)
                    {
                        var slot = slots[j];
                        var comma = j < slots.Count - 1 ? "," : "";
                        @:{ id: @slot.Id, label: "@slot.Slot" }@comma
                                                                                                                                                                                                                                                                                                                                            }
                    @: ]@(i < Model.AvailableDates.Count - 1 ? "," : "")
                    }
                                                                                                                                                                    };

        // When user selects a date, show time slot buttons
        dateRadios.forEach(radio => {
            radio.addEventListener("change", function () {
                const selectedDateId = this.getAttribute("data-date-id");
                const slots = dateSlotMap[selectedDateId] || [];

                timeSlotContainer.innerHTML = "";
                timeSlotInput.value = "";

                // This?
                if (slots.length === 0) {
                    timeSlotContainer.innerHTML = "<p class='text-danger'>Ingen ledige timer.</p>";
                    return;
                }

                slots.forEach(slot => {
                    const btn = document.createElement("button");
                    btn.type = "button";
                    btn.className = "btn btn-outline-primary mb-1";
                    btn.textContent = slot.label;
                    btn.onclick = () => {
                        timeSlotInput.value = slot.id;
                        document.querySelectorAll("#time-slot-buttons button").forEach(b => b.classList.remove("active"));
                        btn.classList.add("active");
                    };
                    timeSlotContainer.appendChild(btn);
                });

                // porridge86: Fixed, Automatically select existing TimeSlots when editing
                const currentSlotId = timeSlotInput.value;
                if (currentSlotId) {
                    const matchBtn = Array.from(timeSlotContainer.children).find(b => b.textContent === currentSlotId);
                    if (matchBtn) matchBtn.classList.add("active");
                }

                // Porridge86: Added, Display a note if there is only one vacancy and it is the booked reservation slot
                const availableCount = slots.length;
                const editingSlotId = parseInt("@Model.TimeSlotId");
                const onlyOwnSlot = availableCount === 1 && slots[0].id === editingSlotId;

                if (onlyOwnSlot) {
                    const warning = document.createElement("p");
                    warning.className = "text-danger mt-2";
                    warning.textContent = "Det er ingen andre ledige timer denne dagen.";
                    timeSlotContainer.appendChild(warning);
                }
            });
        });

        // porridge86: Fixed, Select existing date when editing and fire change event
        window.addEventListener("DOMContentLoaded", function () {
            const selectedDateValue = "@Model.SelectedDate";
            const selectedSlotId = "@Model.TimeSlotId";

            if (selectedDateValue) {
                const selectedRadio = Array.from(dateRadios).find(r => r.value === selectedDateValue);
                if (selectedRadio) {
                    selectedRadio.checked = true;
                    selectedRadio.dispatchEvent(new Event("change")); // Time zone button
                }
            }

            if (selectedSlotId) {
                timeSlotInput.value = selectedSlotId;
                // porridge86: Fixed, Add active after time zone button is generated
                setTimeout(() => {
                    const buttons = document.querySelectorAll("#time-slot-buttons button");
                    buttons.forEach(btn => {
                        if (btn.textContent === selectedSlotId) {
                            btn.classList.add("active");
                        }
                    });
                }, 200);
            }
        });

        function confirmCancel(id) {
            if (confirm("Do you want to cancel this appointment?")) {
                window.location.href = '/Booking/CancelAppointment/' + id;
            }
        }
    </script>
    @await Html.PartialAsync("_ValidationScriptsPartial")
}